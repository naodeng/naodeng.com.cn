---
import { LOCALES, useTranslations, type Lang } from "@/i18n";
import Layout from "@/layouts/Base.astro";
import { getCollection } from "astro:content";
import PageHeadline from "@/components/PageHeadline.astro";
import { ARCHIVE_PAGE_TITLE } from "@/consts";

const locale = Astro.currentLocale as Lang;
const t = useTranslations(locale);

const title = t(ARCHIVE_PAGE_TITLE);

// 获取并按日期排序
const allPosts = (await getCollection("blog"))
  .filter((post) => post.id.split("/")[0] === locale)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// 按年份分组
const postsByYear = allPosts.reduce((acc, post) => {
  const year = post.data.date.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof allPosts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));

export const getStaticPaths = () =>
  Object.keys(LOCALES).map((lang) => ({
    params: { lang },
  }));
---

<Layout {title}>
  <PageHeadline {title} />

  <div class="archive-list">
    {years.map((year) => (
      <section class="year-section">
        <h2 class="year-title">{year}</h2>
        <ul class="posts-list">
          {postsByYear[Number(year)].map((post) => {
            const [, ...idParts] = post.id.split("/");
            const postUrl = `/${locale}/blog/${idParts.join("/")}/`;
            const dateStr = post.data.date.toLocaleDateString(
              locale === "zh-cn" ? "zh-CN" : "en-US",
              { month: "short", day: "numeric" }
            );
            return (
              <li>
                <div class="post-item">
                  <span class="date">{dateStr}</span>
                  <a href={postUrl} class="post-title">
                    {post.data.title}
                  </a>
                </div>
              </li>
            );
          })}
        </ul>
      </section>
    ))}
  </div>
</Layout>

<style>
  .archive-list {
    margin-block-start: var(--sp-l);
  }
  .year-section {
    margin-block-end: var(--sp-l);
  }
  .year-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--color-theme);
    margin-block-end: var(--sp-m);
    padding-inline-start: var(--sp-s);
    border-inline-start: 4px solid var(--color-theme);
  }
  .posts-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .post-item {
    display: flex;
    align-items: baseline;
    gap: var(--sp-m);
    padding-block: var(--sp-s);
    border-block-end: 1px solid color-mix(in srgb, var(--color-main) 10%, transparent);
    transition: background 0.2s ease;
  }
  .post-item:hover {
    background: color-mix(in srgb, var(--color-theme) 4%, transparent);
  }
  .date {
    font-family: var(--english-font);
    font-size: 0.9rem;
    opacity: 0.6;
    min-inline-size: 5rem;
  }
  .post-title {
    font-weight: 600;
    line-height: 1.4;
    text-decoration: none;
    color: inherit;
  }
  .post-title:hover {
    color: var(--color-theme);
    text-decoration: underline;
  }
</style>
