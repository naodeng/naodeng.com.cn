---
import { SEARCH_PLACEHOLDER, SEARCH_NO_RESULTS, SEARCH_OPEN_HINT } from "@/consts";
import { useTranslations, type Lang } from "@/i18n";

const locale = Astro.currentLocale as Lang;
const t = useTranslations(locale);

const algoliaAppId = import.meta.env.PUBLIC_ALGOLIA_APP_ID ?? "";
const algoliaSearchKey = import.meta.env.PUBLIC_ALGOLIA_SEARCH_KEY ?? "";
const algoliaIndexName = import.meta.env.PUBLIC_ALGOLIA_INDEX_NAME ?? "";
const useAlgolia = Boolean(algoliaAppId && algoliaSearchKey && algoliaIndexName);
---

<dialog id="search-dialog" class="search-dialog" aria-label={t(SEARCH_PLACEHOLDER)}>
  <div class="search-backdrop" data-close></div>
  <div class="search-box">
    <label for="search-input" class="visually-hidden">{t(SEARCH_PLACEHOLDER)}</label>
    <input
      id="search-input"
      type="search"
      class="search-input"
      placeholder={t(SEARCH_PLACEHOLDER)}
      autocomplete="off"
      enterkeyhint="search"
    />
    <span class="search-hint" data-hint>{t(SEARCH_OPEN_HINT)}</span>
  </div>
  <div class="search-results" id="search-results" role="list"></div>
  <p class="search-empty" id="search-empty" hidden>{t(SEARCH_NO_RESULTS)}</p>
</dialog>

<script is:inline define:vars={{ useAlgolia, algoliaAppId, algoliaSearchKey, algoliaIndexName }}>
  /* global useAlgolia, algoliaAppId, algoliaSearchKey, algoliaIndexName */
  const dialog = document.getElementById("search-dialog");
  const input = document.getElementById("search-input");
  const resultsEl = document.getElementById("search-results");
  const emptyEl = document.getElementById("search-empty");
  const backdrop = document.querySelector(".search-backdrop[data-close]");
  const hintEl = document.querySelector("[data-hint]");

  let index = [];
  let locale = "en";
  let algoliaClient = null;
  let algoliaDebounce = null;
  let lastAlgoliaQuery = "";

  function getLocale() {
    const el = document.documentElement.getAttribute("data-locale");
    return el === "zh-cn" ? "zh-cn" : "en";
  }

  async function loadIndex() {
    if (index.length > 0) return index;
    locale = getLocale();
    const res = await fetch(`/${locale}/search-index.json`);
    if (!res.ok) return [];
    index = await res.json();
    return index;
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  function renderItems(items, hasQuery) {
    resultsEl.innerHTML = "";
    resultsEl.hidden = items.length === 0;
    emptyEl.hidden = items.length > 0 || !hasQuery;

    items.slice(0, 20).forEach((item) => {
      const a = document.createElement("a");
      a.href = item.url;
      a.className = "search-result-item";
      a.setAttribute("role", "listitem");
      const dateStr = new Date(item.date).toLocaleDateString(locale === "zh-cn" ? "zh-CN" : "en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
      a.innerHTML = `
        <span class="search-result-title">${escapeHtml(item.title)}</span>
        <span class="search-result-meta">${escapeHtml(dateStr)}${item.tags?.length ? " Â· " + item.tags.slice(0, 3).join(", ") : ""}</span>
      `;
      a.addEventListener("click", () => dialog.close());
      resultsEl.appendChild(a);
    });
  }

  function filter(q) {
    const lower = q.trim().toLowerCase();
    if (!lower) return [];
    return index.filter(
      (item) =>
        item.title.toLowerCase().includes(lower) ||
        item.description.toLowerCase().includes(lower) ||
        (item.tags && item.tags.some((t) => t.toLowerCase().includes(lower)))
    );
  }

  async function algoliaSearch(query) {
    if (!algoliaClient) {
      const { algoliasearch } = await import("algoliasearch");
      algoliaClient = algoliasearch(algoliaAppId, algoliaSearchKey);
    }
    locale = getLocale();
    const { hits } = await algoliaClient.searchSingleIndex({
      indexName: algoliaIndexName,
      searchParams: {
        query,
        facetFilters: [["lang:" + locale]],
        hitsPerPage: 20,
      },
    });
    return hits;
  }

  function onInput() {
    const q = input.value;
    const hasQuery = q.trim().length > 0;

    if (useAlgolia) {
      if (!hasQuery) {
        renderItems([], false);
        return;
      }
      if (algoliaDebounce) clearTimeout(algoliaDebounce);
      algoliaDebounce = setTimeout(async () => {
        const queryAtRequest = q;
        lastAlgoliaQuery = queryAtRequest;
        algoliaDebounce = null;
        try {
          const items = await algoliaSearch(queryAtRequest);
          if (lastAlgoliaQuery === queryAtRequest) renderItems(items, true);
        } catch (err) {
          console.error("Algolia search error:", err);
          if (lastAlgoliaQuery === queryAtRequest) renderItems([], true);
        }
      }, 200);
      return;
    }

    if (!index.length) {
      resultsEl.hidden = true;
      emptyEl.hidden = true;
      return;
    }
    const items = filter(q);
    renderItems(items, hasQuery);
  }

  function openSearch() {
    locale = getLocale();
    if (useAlgolia) {
      dialog.showModal();
      input.value = "";
      input.focus();
      resultsEl.hidden = true;
      emptyEl.hidden = true;
      if (hintEl) hintEl.style.display = "block";
      return;
    }
    loadIndex().then(() => {
      dialog.showModal();
      input.value = "";
      input.focus();
      resultsEl.hidden = true;
      emptyEl.hidden = true;
      if (hintEl) hintEl.style.display = "block";
    });
  }

  function closeSearch() {
    dialog.close();
    if (hintEl) hintEl.style.display = "";
  }

  dialog.addEventListener("close", () => {
    if (hintEl) hintEl.style.display = "";
  });

  dialog.addEventListener("cancel", closeSearch);

  backdrop?.addEventListener("click", closeSearch);

  input.addEventListener("input", onInput);
  input.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeSearch();
      e.preventDefault();
    }
    if (e.key === "Enter") {
      const first = resultsEl.querySelector(".search-result-item");
      if (first) {
        first.click();
        e.preventDefault();
      }
    }
  });

  document.addEventListener("keydown", (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === "k") {
      e.preventDefault();
      if (dialog.open) closeSearch();
      else openSearch();
    }
  });

  document.querySelectorAll("[data-search-open]").forEach((el) => {
    el.addEventListener("click", openSearch);
  });

  window.addEventListener("search-open", openSearch);
</script>

<style>
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  .search-dialog {
    position: fixed;
    inset: 0;
    width: 100%;
    max-width: 100%;
    max-height: 100%;
    margin: 0;
    padding: var(--sp-m);
    border: none;
    background: transparent;
    z-index: 1000;
  }

  .search-dialog::backdrop {
    background: color-mix(in srgb, var(--color-main) 20%, transparent);
    backdrop-filter: blur(4px);
  }

  .search-backdrop {
    position: absolute;
    inset: 0;
    cursor: pointer;
  }

  .search-box {
    position: relative;
    max-inline-size: 560px;
    margin-inline: auto;
    margin-block-start: 10vh;
  }

  .search-input {
    display: block;
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 1.1rem;
    font-family: inherit;
    color: var(--color-main);
    background: var(--color-base);
    border: 2px solid var(--color-theme);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  }

  .search-input::placeholder {
    opacity: 0.7;
  }

  .search-input:focus {
    outline: none;
    box-shadow: 0 0 0 4px color-mix(in srgb, var(--color-theme) 25%, transparent);
  }

  .search-hint {
    display: block;
    margin-block-start: 0.5rem;
    font-size: 0.85rem;
    opacity: 0.6;
  }

  .search-results {
    max-inline-size: 560px;
    margin-inline: auto;
    margin-block-start: 1rem;
    max-height: 60vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    background: var(--color-base);
    border-radius: 12px;
    padding: 0.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  }

  .search-results[hidden] {
    display: none;
  }

  .search-result-item {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    color: inherit;
    text-decoration: none;
    transition: background 0.2s ease;
  }

  .search-result-item:hover,
  .search-result-item:focus-visible {
    background: color-mix(in srgb, var(--color-theme) 10%, transparent);
  }

  .search-result-title {
    font-weight: 700;
    color: var(--color-main);
  }

  .search-result-meta {
    font-size: 0.85rem;
    opacity: 0.7;
  }

  .search-empty {
    max-inline-size: 560px;
    margin-inline: auto;
    margin-block-start: 1rem;
    padding: 1rem;
    text-align: center;
    opacity: 0.8;
  }
</style>
