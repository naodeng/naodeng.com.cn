---
/**
 * Giscus 评论组件（基于 GitHub Discussions）
 * 默认使用 naodeng/naodeng.com.cn 的配置；可通过 .env 覆盖：
 *   PUBLIC_GISCUS_REPO、PUBLIC_GISCUS_REPO_ID、PUBLIC_GISCUS_CATEGORY、PUBLIC_GISCUS_CATEGORY_ID
 *
 * 控制台出现 giscus.app/api/discussions 404 且提示 "Discussion not found. A new discussion
 * will be created if a comment/reaction is submitted." 为正常：该页尚未有讨论，首次有人评论/反应时会自动创建。
 */
const GISCUS_DEFAULTS = {
  repo: "naodeng/naodeng.com.cn",
  repoId: "R_kgDOHntNtg",
  category: "Show and tell",
  categoryId: "DIC_kwDOHntNts4Cavst",
};

interface Props {
  /** 界面语言，与 giscus 支持的语言代码一致，如 zh-CN、en */
  lang?: string;
  /** 主题：light | dark | preferred_color_scheme */
  theme?: string;
  /** 评论框位置：top | bottom */
  inputPosition?: "top" | "bottom";
  /** 是否启用主帖反应 */
  reactionsEnabled?: boolean;
  /** 是否懒加载 */
  loading?: "lazy" | "eager";
}

const {
  lang = "zh-CN",
  theme = "preferred_color_scheme",
  inputPosition = "bottom",
  reactionsEnabled = true,
  loading = "lazy",
} = Astro.props;

const repo = (import.meta.env.PUBLIC_GISCUS_REPO as string | undefined) ?? GISCUS_DEFAULTS.repo;
const repoId = (import.meta.env.PUBLIC_GISCUS_REPO_ID as string | undefined) ?? GISCUS_DEFAULTS.repoId;
const category = (import.meta.env.PUBLIC_GISCUS_CATEGORY as string | undefined) ?? GISCUS_DEFAULTS.category;
const categoryId = (import.meta.env.PUBLIC_GISCUS_CATEGORY_ID as string | undefined) ?? GISCUS_DEFAULTS.categoryId;

const enabled = Boolean(repo && repoId && category && categoryId);
---

{enabled && (
  <section class="giscus-section" aria-label={lang === "zh-CN" ? "评论" : "Comments"}>
    <p class="giscus-hint">
      {lang === "zh-CN"
        ? "评论由 GitHub Discussions 驱动，首次在本页留言将自动创建讨论线程。"
        : "Comments are powered by GitHub Discussions. The first comment on this page will create the discussion."}
    </p>
    <div class="giscus"></div>
    <script is:inline
      src="https://giscus.app/client.js"
      data-repo={repo}
      data-repo-id={repoId}
      data-category={category}
      data-category-id={categoryId}
      data-mapping="url"
      data-strict="0"
      data-reactions-enabled={reactionsEnabled ? "1" : "0"}
      data-emit-metadata="0"
      data-input-position={inputPosition}
      data-theme={theme}
      data-lang={lang}
      data-loading={loading}
      crossorigin="anonymous"
      async
    />
  </section>
)}

<style>
  .giscus-section {
    margin-block-start: var(--sp-l);
    padding-block-start: var(--sp-l);
    border-block-start: 1px solid color-mix(in srgb, var(--color-theme) 14%, transparent);
  }
  .giscus-hint {
    font-size: 0.85rem;
    color: var(--color-main);
    opacity: 0.7;
    margin: 0 0 0.75rem 0;
  }
  .giscus-section :global(.giscus-frame) {
    width: 100%;
  }
</style>
