<!DOCTYPE html><html lang="zh-CN"> <head><meta charset="UTF-8"><title>UI 测试最佳实践的真实案例篇（二）：从难以理解的 React 组件测试到简单愚蠢的测试 - 软件测试同学</title><meta name="description" content="naodeng，naodeng.com.cn，naodeng，个人博客，软件测试，性能测试，接口测试，自动化测试，敏捷测试。"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="sitemap" href="/sitemap-index.xml"><meta name="generator" content="Astro v5.17.0"><link rel="alternate" hreflang="en-US" href="https://naodeng.com.cn/en/blog/ui-automation-testing/ui-testing-best-practice-real-life-examples-from-unreadable-react-component-tests-to-simple-ones/"><link rel="alternate" hreflang="zh-CN" href="https://naodeng.com.cn/zh-cn/blog/ui-automation-testing/ui-testing-best-practice-real-life-examples-from-unreadable-react-component-tests-to-simple-ones/"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="icon" sizes="192x192" href="/android-chrome-192x192.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><meta name="color-scheme" content="light dark"><meta property="og:type" content="website"><meta property="og:title" content="UI 测试最佳实践的真实案例篇（二）：从难以理解的 React 组件测试到简单愚蠢的测试 - 软件测试同学"><meta property="og:site_name" content="UI 测试最佳实践的真实案例篇（二）：从难以理解的 React 组件测试到简单愚蠢的测试 - 软件测试同学"><meta property="og:description" content="naodeng，naodeng.com.cn，naodeng，个人博客，软件测试，性能测试，接口测试，自动化测试，敏捷测试。"><meta property="og:image" content="https://naodeng.com.cn/ogp.png"><meta property="og:url" content="https://naodeng.com.cn/zh-cn/blog/ui-automation-testing/ui-testing-best-practice-real-life-examples-from-unreadable-react-component-tests-to-simple-ones/"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@inaodeng"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="preload" as="style" fetchpriority="high" href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;800&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;800&display=swap" media="print" onload="this.media='all'"><link rel="preload" as="style" fetchpriority="high" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp&display=swap" media="print" onload="this.media='all'"><link rel="preload" as="style" fetchpriority="high" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;800&display=swap"><link rel="stylesheet" media="print" onload="this.media='all'" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;800&display=swap"><style>
      body {
        font-family: "Noto Sans SC", sans-serif;
      }
    </style><style>article[data-astro-cid-uwv4mmhs]{>*{margin-block:1.2em 0;margin-inline:0}p{font-weight:400}h2{margin-block:3em 0;padding-block-end:.2em;border-inline-start:4px solid var(--color-accent);padding-inline-start:var(--sp-s);line-height:1.4;font-size:1.6rem}h3{margin-block:2em 0;padding-block-end:.2em;line-height:1.4;font-size:1.4rem;border-block-end:1px solid color-mix(in srgb,var(--color-main) 10%,transparent)}h4{margin-block:2em -.4em;line-height:1.4;font-size:1.1rem}ul{list-style:disc;padding-inline-start:1.5em}ol{list-style:decimal;padding-inline-start:1.5em}li{margin-block:0 .5em;line-height:1.4}:not(pre) code{font-family:Consolas,Courier New,Courier,Monaco,monospace;color:var(--color-theme);background-color:color-mix(in srgb,var(--color-main) 8%,transparent);padding-block:.2em;padding-inline:.4em;border-radius:2px;font-size:.9rem}blockquote{font-style:italic;color:color-mix(in srgb,var(--color-main) 80%,transparent);background:color-mix(in srgb,var(--color-main) 5%,transparent);padding:1em;border-inline-start:2px solid color-mix(in srgb,var(--color-main) 10%,transparent)}a{text-decoration:underline;color:var(--color-theme);font-weight:500}img{border-radius:4px;background-color:color-mix(in srgb,var(--color-main) 10%,transparent)}pre{direction:ltr;padding:1em;border-radius:4px;border:2px solid color-mix(in srgb,var(--color-main) 20%,transparent)}}header[data-astro-cid-v3cnrnum]{text-align:center;border-block-end:1px solid var(--color-theme);padding-block-end:var(--sp-m);display:flex;flex-direction:column;align-items:center;gap:.5rem}header[data-astro-cid-v3cnrnum] h1[data-astro-cid-v3cnrnum]{color:var(--color-theme);font-size:1.8rem;margin:0}.cover[data-astro-cid-v3cnrnum]{border-radius:16px;margin:0}.tags[data-astro-cid-v3cnrnum]{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-block-start:.5rem}.tag[data-astro-cid-v3cnrnum]{background-color:var(--color-theme);color:#fff;padding:.2rem .5rem;border-radius:4px;font-size:.8rem}
</style>
<link rel="stylesheet" href="/_astro/_id_.CXLwv1yp.css"></head> <body> <div id="js-languageSuggest" data-astro-cid-onlux7ho> <a id="js-link" href="#" data-astro-cid-onlux7ho> <span class="material-icons-sharp" data-astro-cid-onlux7ho>autorenew</span> <span id="js-linkText" data-astro-cid-onlux7ho></span> </a> <button id="js-close" data-astro-cid-onlux7ho> <span class="material-icons-sharp" data-astro-cid-onlux7ho>close</span> </button> </div> <script>(function(){const currentLocale = "zh-cn";
const LOCALES = {"en":{"label":"English","lang":"en-US"},"zh-cn":{"label":"简体中文","lang":"zh-CN"}};

  const browserLang = navigator.language.toLowerCase();
  const suggest = document.getElementById("js-languageSuggest");

  const showSuggest = (lang) => {
    const pathnames = location.pathname.split("/");
    const link = document.getElementById("js-link");
    const linkText = document.getElementById("js-linkText");
    pathnames[1] = lang;
    link.href = pathnames.join("/");
    linkText.innerText = LOCALES[lang].label;
    suggest.style.display = "block";
  };

  if (
    currentLocale === browserLang ||
    currentLocale === browserLang.split("-")[0] ||
    localStorage.languageSuggestDenied ||
    localStorage.selectedLang
  ) {
    return;
  } else if (Object.keys(LOCALES).includes(browserLang)) {
    showSuggest(browserLang);
  } else if (Object.keys(LOCALES).includes(browserLang.split("-")[0])) {
    showSuggest(browserLang.split("-")[0]);
  }

  document.getElementById("js-close").addEventListener("click", () => {
    suggest.style.display = "none";
    localStorage.languageSuggestDenied = true;
  });
})();</script>  <header class="l-header" data-astro-cid-3ef6ksr2> <h1 dir="ltr" data-astro-cid-3ef6ksr2> <a href="/zh-cn/" data-astro-cid-3ef6ksr2>软件测试同学</a> </h1> <label data-astro-cid-opxux4jt> <span class="material-icons-sharp" data-astro-cid-opxux4jt>translate</span> <select data-languageSelect data-astro-cid-opxux4jt> <option label="English" value="/en/blog/ui-automation-testing/ui-testing-best-practice-real-life-examples-from-unreadable-react-component-tests-to-simple-ones/" data-lang="en" data-astro-cid-opxux4jt></option><option label="简体中文" value="/zh-cn/blog/ui-automation-testing/ui-testing-best-practice-real-life-examples-from-unreadable-react-component-tests-to-simple-ones/" data-lang="zh-cn" selected data-astro-cid-opxux4jt></option> </select> <span class="material-icons-sharp" data-astro-cid-opxux4jt>expand_more</span> </label> <script>
  const selects = document.querySelectorAll("[data-languageSelect]");
  selects.forEach((select) => {
    select.addEventListener("change", (event) => {
      localStorage.selectedLang = event.target?.selectedOptions[0].dataset.lang;
      location.href = event.target?.value;
    });
  });
</script>  <nav class="l-content" data-astro-cid-3ef6ksr2> <ul data-astro-cid-3ef6ksr2> <li data-astro-cid-3ef6ksr2> <a href="/zh-cn/" data-astro-cid-3ef6ksr2> 首页 </a> </li> <li data-astro-cid-3ef6ksr2> <a href="/zh-cn/blog/" data-astro-cid-3ef6ksr2> 博客 </a> </li> <li data-astro-cid-3ef6ksr2> <a href="/zh-cn/archive/" data-astro-cid-3ef6ksr2> 归档 </a> </li> <li data-astro-cid-3ef6ksr2> <a href="/zh-cn/projects/" data-astro-cid-3ef6ksr2> 项目 </a> </li> <li data-astro-cid-3ef6ksr2> <a href="/zh-cn/about/" data-astro-cid-3ef6ksr2> 关于 </a> </li> <li data-astro-cid-3ef6ksr2> <a href="https://github.com/naodeng/naodeng.com.cn" target="_blank" data-astro-cid-3ef6ksr2>
GitHub
<span class="material-icons-sharp dir" data-astro-cid-3ef6ksr2>open_in_new</span> </a> </li> </ul> </nav> </header>  <main class="l-main l-content">  <article data-astro-cid-uwv4mmhs> <img src="/_astro/UI-Testing-best-practice-real-life-examples-from-unreadable-react-component-tests-to-simple-ones-cover.C7dqAtPi_1BI41f.webp" alt="UI 测试最佳实践的真实案例篇（二）：从难以理解的 React 组件测试到简单愚蠢的测试" data-astro-cid-v3cnrnum="true" loading="lazy" decoding="async" fetchpriority="auto" width="1200" height="630" class="cover"><header data-astro-cid-v3cnrnum> <h1 data-astro-cid-v3cnrnum>UI 测试最佳实践的真实案例篇（二）：从难以理解的 React 组件测试到简单愚蠢的测试</h1> <time datetime="2024-02-02T08:37:44.000Z" data-astro-cid-v3cnrnum> 2024/2/2 </time> <div class="tags" data-astro-cid-v3cnrnum> <span class="tag" data-astro-cid-v3cnrnum>UI Testing</span><span class="tag" data-astro-cid-v3cnrnum>Best Practices</span> </div> </header> <p>文章由 <a href="https://github.com/NoriSte/ui-testing-best-practices">UI 测试最佳实践项目</a> 内容翻译而来，大家有条件的话可以去 <a href="https://github.com/NoriSte/ui-testing-best-practices">UI 测试最佳实践项目</a>阅读原文。</p>
<h2 id="真实案例从难以理解的-react-组件测试到简单愚蠢的测试">真实案例：从难以理解的 React 组件测试到简单愚蠢的测试</h2>
<p>原文链接：<a href="https://github.com/NoriSte/ui-testing-best-practices/blob/master/sections/real-life-examples/from-unreadable-react-component-tests-to-simple-ones.md">https://github.com/NoriSte/ui-testing-best-practices/blob/master/sections/real-life-examples/from-unreadable-react-component-tests-to-simple-ones.md</a></p>
<h3 id="一段简要说明">一段简要说明</h3>
<p>测试的代码应该尽量清晰易懂。这样做的好处是在需要理解、更新、重构或修复代码时，能够节省大量时间。相反，如果你连自己写的测试都读不懂，那可就是个糟糕的场景了！</p>
<p>这里我将分享一下我对一些旧的 React 组件测试进行重构的原因、思考过程和模式。</p>
<h3 id="问题">问题</h3>
<p>在添加了<a href="https://github.com/NoriSte/ui-testing-best-practices/blob/master/sections/tools/cypress-and-storybook-exposing-component-from-story.zh.md">”使用 Cypress 和 Storybook 测试虚拟列表组件”</a>章节和<a href="https://github.com/NoriSte/ui-testing-best-practices/blob/master/sections/tools/cypress-react-component-test.zh.md">”使用 Cypress 进行 React 组件单元测试”</a>章节一年后，我发现我的测试几乎无法阅读。许多抽象层次使我无法仔细理解测试在做什么，导致花费很长时间阅读它们。这是无法接受的阻力。</p>
<h3 id="如何提高测试的可读性">如何提高测试的可读性？</h3>
<p>TDD 之父 Kent Beck 曾说：</p>
<blockquote>
<p>测试代码不是生产代码。它必须简单且小 1000 倍。</p>
</blockquote>
<p>但是，如何做到呢？是什么导致我的测试如此难以阅读？是什么使可读性变差？</p>
<p>我将分析一堆我的测试，对它们进行思考，并提出更为直观的方法。被测试的组件是前文提到的 VirtualList。</p>
<h4 id="测试-1复杂度低">测试 1，复杂度低</h4>
<p>接下来的测试是最简单的一个：检查当没有传递任何内容时，VirtualList 是否不渲染任何东西。以下是原始测试</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When there are no items, then nothing is showed&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemsAmount</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 300</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getStoryItems</span><span style="color:#E1E4E8">({ amount: itemsAmount })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">createRenderItem</span><span style="color:#E1E4E8">({ height: itemHeight })}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByTestId</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;VirtualList&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">$el</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> $el.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.empty&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<p>考虑到测试的简单性，谈论可读性是否有点过于琐碎？不，我已经对此有一些疑问，比如：</p>
<ul>
<li><code>getStoryItems</code> 是做什么的？</li>
<li><code>createRenderItem</code> 是做什么的？</li>
</ul>
<p>我这里没有贴出 <code>getStoryItems</code> 的代码，但它只是一个生成包含 X 个项目的数组的函数，形式为 <code>[{ id: 1, name: &#39;Item 1&#39; }, { id: 2, name: &#39;Item 2&#39; }, /* 等等 */]</code>。它的目的是轻松生成数千个项目，但我编写它的初衷是为了更轻松地编写没有测试意识的 Storybook 故事！然后，我将其重新用于测试，但故事和测试有完全不同的需求和目的！</p>
<p>与此同时，<code>createRenderItem</code> 是一个工厂，生成列表项（一些 React 组件）。同样，我为 Storybook 设计它是为了使其更具动态性，而测试并不是我最初考虑的。</p>
<p>这两个函数都很容易阅读，但为什么要强迫读者跟随这些抽象？它们是必需的吗？答案是否定的。</p>
<p>以下是测试的简化代码，列出了其中的差异。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When there are no items, then nothing is showed&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Arrange</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#79B8FF">90</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Assert</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByTestId</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;VirtualList&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">$el</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> $el.</span><span style="color:#B392F0">text</span><span style="color:#E1E4E8">())</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.empty&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const itemsAmount = 0</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const itemHeight = 30</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const listHeight = 300</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const items = getStoryItems({ amount: itemsAmount })</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>const items = [];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">mount(</span></span>
<span class="line"><span style="color:#E1E4E8">  &lt;VirtualList</span></span>
<span class="line"><span style="color:#E1E4E8">    items={items}</span></span>
<span class="line"><span style="color:#E1E4E8">    listHeight={listHeight}</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>   getItemHeights={() =&gt; itemHeight}</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>   getItemHeights={() =&gt; 30}</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>   RenderItem={createRenderItem({ height: itemHeight })}</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>   RenderItem={RenderItem}</span></span>
<span class="line"><span style="color:#E1E4E8">  /&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span></code></pre>
<p>在简化的测试中，最显著的变化有：</p>
<ol>
<li>我显式指定了 <code>items</code>，而不是通过 <code>getStoryItems</code> 生成它们。这样做的目标是立即向读者澄清 VirtualList 渲染的是哪些项目。</li>
<li>我移除了“不必要的”常量。如果没有渲染任何项目，项目的高度和列表的高度是无关紧要的。</li>
<li>我取消了 <code>createRenderItem</code> 工厂的必要性。在这里，生成预先设置高度的组件是无用的。</li>
</ol>
<h4 id="测试-2中等复杂度">测试 2，中等复杂度</h4>
<p>接下来的测试并不复杂。但我实现它的方式在不必要的情况下增加了复杂度</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When the list receives 10000 items, then only the minimum number of them are rendered&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemsAmount</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 10000</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 300</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getStoryItems</span><span style="color:#E1E4E8">({ amount: itemsAmount })</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> visibleItemsAmount</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> listHeight </span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> itemHeight</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">createRenderItem</span><span style="color:#E1E4E8">({ height: itemHeight })}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> visibleItems</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> items.</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, visibleItemsAmount </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">  itemsShouldBeVisible</span><span style="color:#E1E4E8">(visibleItems)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // first not-rendered item check</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(items[visibleItemsAmount])).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;not.exist&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<p>在这里情况变得更加奇怪。再次出现了一些简单的抽象，但读者必须：</p>
<ul>
<li>理解 <code>visibleItemsAmount</code> 的值。</li>
<li>通过阅读 <code>items.slice</code> 理解 <code>visibleItems</code> 包含什么。再一次，多了一层复杂性。</li>
<li>猜测 <code>itemsShouldBeVisible</code> 是做什么的，或者阅读它的代码。</li>
<li>猜测 <code>items[visibleItemsAmount]</code> 包含什么。</li>
</ul>
<p>是的，有一些注释。是的，我尝试创建有意义的名称。但我可以简化它很多。</p>
<p>还有一件事。想象一下这种情况：测试失败了。不管你做了什么，这个测试都失败了。你开始调试它，但你知道调试一个高度动态的测试（你不知道 <code>items</code>，<code>visibleItemsAmount</code>，<code>visibleItems</code>，<code>items[visibleItemsAmount]</code> 在前期包含什么）是很困难的。你需要在测试代码中添加 <code>console.log</code>/<code>cy.log</code>/<code>debugger</code>/断点，以对测试管理的内容有一个整体的概念，然后才能开始调试 VirtualList。我能避免未来的调试问题吗？我需要测试渲染 10,000 个项目吗？</p>
<p>以下是我如何改进测试的方式。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When the list is longer than the available space, then only the minimum number of items are rendered&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Arrange</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // creating the data</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#6A737D">    // visible ones</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#6A737D">    // invisible one</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 4&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // only 3 items are visible</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 90</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // mounting the component</span></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Act</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Assert</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 4&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;not.exist&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>同样，在这里，唯一而且关键的改变是为未来的读者/调试者提供了更轻松的体验。你不需要猜测/计算/记录常量的值，也不需要弄清楚抽象的作用。代码就在你眼前，遵循 KISS 原则（保持简单，傻瓜）。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const itemsAmount = 10000</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const itemHeight = 30</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const listHeight = 300</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const items = getStoryItems({ amount: itemsAmount })</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const visibleItemsAmount = listHeight / itemHeight</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>// creating the data</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>const items = [</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span> // visible ones</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span> { id: 1, name: &#39;Item 1&#39; },</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span> { id: 2, name: &#39;Item 2&#39; },</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span> { id: 3, name: &#39;Item 3&#39; },</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span> // invisible one</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span> { id: 3, name: &#39;Item 4&#39; },</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>// only 3 items are visible</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>const itemHeight = 30;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>const listHeight = 90;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">/* ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>const visibleItems = items.slice(0, visibleItemsAmount - 1)</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>itemsShouldBeVisible(visibleItems)</span></span>
<span class="line"><span style="color:#FDAEB7"><span style="user-select:none">-</span>cy.findByText(getItemText(items[visibleItemsAmount])).should(&#39;not.exist&#39;)</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>cy.findByText(&#39;Item 1&#39;).should(&#39;be.visible&#39;);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>cy.findByText(&#39;Item 2&#39;).should(&#39;be.visible&#39;);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>cy.findByText(&#39;Item 3&#39;).should(&#39;be.visible&#39;);</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select:none">+</span>cy.findByText(&#39;Item 4&#39;).should(&#39;not.exist&#39;);</span></span></code></pre>
<h4 id="测试-3中等复杂度">测试 3，中等复杂度</h4>
<p>在下一个测试中，我们的目标是测试 VirtualList 的 <code>buffer</code> 属性，该属性允许在项目尚不可见时渲染一些项目。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When some items buffered, then they exist in the page&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemsAmount</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1000</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 300</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getStoryItems</span><span style="color:#E1E4E8">({ amount: itemsAmount })</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> visibleItemsAmount</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> listHeight </span><span style="color:#F97583">/</span><span style="color:#E1E4E8"> itemHeight</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> bufferedItemsAmount</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">createRenderItem</span><span style="color:#E1E4E8">({ height: itemHeight })}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#B392F0">      buffer</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{bufferedItemsAmount}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;,</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  fastScrollVirtualList</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> firstRenderedItemIndex</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getFirstRenderedItemIndex</span><span style="color:#E1E4E8">(items, getItemText)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> firstVisibleItemIndex</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> firstRenderedItemIndex </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> bufferedItemsAmount</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> lastVisibleItemIndex</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> firstVisibleItemIndex </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> visibleItemsAmount </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> lastRenderedItemIndex</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> lastVisibleItemIndex </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> bufferedItemsAmount</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    items.</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(firstRenderedItemIndex, firstVisibleItemIndex).</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">item</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(item)).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;not.be.visible&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    items.</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(firstVisibleItemIndex, lastVisibleItemIndex).</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">item</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(item)).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    items.</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(lastVisibleItemIndex, lastRenderedItemIndex).</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">item</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(item)).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;not.be.visible&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<p>复杂性来自于：</p>
<ol>
<li>滚动列表以测试缓冲区在两侧的作用。</li>
<li>当滚动停止时，我无法提前知道哪些项目是可见的，哪些不可见，这就是为什么 <code>fastScrollVirtualList().then(() =&gt; { /* ... */ })</code> 的内容是动态的。</li>
</ol>
<p>我稍后会回到第 2 点，但对于这个测试，我切掉了第 1 点的头：为什么我需要通过 Cypress 组件测试在这里测试整个 <code>buffer</code> 行为？我有很多单元测试，检查内部 VirtualList 函数是否正常工作。我不需要再次测试相同的行为。一旦 <code>buffer</code> 生效，它就在两侧都生效了。这个选择使测试受益匪浅；现在它更简单了，包含了许多有助于读者的注释！</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Should render only the visible items and the buffered ones when an item is partially visible&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Arrange</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // creating the data</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#6A737D">    // visible ones</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#6A737D">    // visible ones</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 4&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#6A737D">    // buffered ones</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 5&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 6&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#6A737D">    // non-rendered one</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 7&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">  // 3 items are fully visible, 1 is partially visible</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">  // 2 items are buffered</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> buffer</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // mounting the component</span></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#B392F0">      buffer</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{buffer}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Act</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Assert</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 4&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 5&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;not.be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 6&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;not.be.visible&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 7&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;not.exist&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<h4 id="测试-4高复杂度">测试 4，高复杂度</h4>
<p>测试选择是 VirtualList 中最困难的部分，因为：</p>
<ol>
<li>VirtualList 管理键盘修饰符，允许简单、累加、减去和范围选择。</li>
<li>VirtualList 是无状态的：我们需要用一个有状态的包装器来包装它，以存储先前的选择，以便测试累加、减去和范围选择。</li>
</ol>
<p>我的旧测试非常难以阅读，因为：</p>
<ol>
<li>有状态的包装器在测试本身的主体中声明，使用测试的范围。</li>
<li>所有的选择都在一个很长的流中被检查。</li>
</ol>
<p>逐步来，让我们简化它。</p>
<h5 id="将抽象移到远处">将抽象移到远处</h5>
<p>旧测试的第一部分如下：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When the items are clicked, then they are selected&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 300</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> testItems</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> WithSelectionManagement</span><span style="color:#F97583">:</span><span style="color:#B392F0"> React</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">FC</span><span style="color:#E1E4E8">&lt;{</span></span>
<span class="line"><span style="color:#B392F0">    testHandleSelect</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">newSelectedIds</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ItemId</span><span style="color:#E1E4E8">[]) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {}</span></span>
<span class="line"><span style="color:#E1E4E8">  }&gt; </span><span style="color:#F97583">=</span><span style="color:#FFAB70"> props</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">testHandleSelect</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> props</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getStoryItems</span><span style="color:#E1E4E8">({ amount: </span><span style="color:#79B8FF">10000</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">selectedItems</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">setSelectedItems</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> React.</span><span style="color:#B392F0">useState</span><span style="color:#E1E4E8">&lt;(</span><span style="color:#79B8FF">string</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)[]&gt;([])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> handleSelect</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> React.</span><span style="color:#B392F0">useCallback</span><span style="color:#E1E4E8">&lt;(</span><span style="color:#FFAB70">params</span><span style="color:#F97583">:</span><span style="color:#B392F0"> OnSelectCallbackParams</span><span style="color:#E1E4E8">&lt;</span><span style="color:#B392F0">StoryItem</span><span style="color:#E1E4E8">&gt;) </span><span style="color:#F97583">=&gt;</span><span style="color:#79B8FF"> void</span><span style="color:#E1E4E8">&gt;(</span></span>
<span class="line"><span style="color:#E1E4E8">      ({ </span><span style="color:#FFAB70">newSelectedIds</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        setSelectedItems</span><span style="color:#E1E4E8">(newSelectedIds)</span></span>
<span class="line"><span style="color:#B392F0">        testHandleSelect</span><span style="color:#E1E4E8">(newSelectedIds)</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      [setSelectedItems, testHandleSelect],</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    React.</span><span style="color:#B392F0">useEffect</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      testItems </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> items</span></span>
<span class="line"><span style="color:#E1E4E8">    }, [items])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">      &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">        items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">        getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">        RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#B392F0">createSelectableRenderItem</span><span style="color:#E1E4E8">({ height: itemHeight })}</span></span>
<span class="line"><span style="color:#B392F0">        listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#B392F0">        updateScrollModeOnDataChange</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{{</span></span>
<span class="line"><span style="color:#E1E4E8">          addedAtTop: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          removedFromTop: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          addedAtBottom: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          removedFromBottom: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        }}</span></span>
<span class="line"><span style="color:#B392F0">        selectedItemIds</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{selectedItems}</span></span>
<span class="line"><span style="color:#B392F0">        onSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{handleSelect}</span></span>
<span class="line"><span style="color:#E1E4E8">      /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">  WithSelectionManagement.displayName </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> &#39;WithSelectionManagement&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(&lt;</span><span style="color:#79B8FF">WithSelectionManagement</span><span style="color:#B392F0"> testHandleSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{cy.</span><span style="color:#B392F0">stub</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">as</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;handleSelect&#39;</span><span style="color:#E1E4E8">)} /&gt;)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  /* ... rest of the test ... */</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<p>以这样的样板开始阅读测试是相当困难的。你在阅读中迷失了一段时间，失去了测试本身的关键部分。让我们将其从测试中移到远处。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#6A737D">// wrap the VirtualList to internally manage the selection, passing outside only the new selection</span></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> SelectableList</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">props</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">onSelect</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">...</span><span style="color:#79B8FF">virtualListProps</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> props;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // store the selection in an internal state</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">selectedItems</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">setSelectedItems</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> React.</span><span style="color:#B392F0">useState</span><span style="color:#E1E4E8">([]);</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> handleSelect</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> React.</span><span style="color:#B392F0">useCallback</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    ({ </span><span style="color:#FFAB70">newSelectedIds</span><span style="color:#E1E4E8"> }) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">      setSelectedItems</span><span style="color:#E1E4E8">(newSelectedIds);</span></span>
<span class="line"><span style="color:#6A737D">      // call the passed spy to notify the test about the new selected ids</span></span>
<span class="line"><span style="color:#B392F0">      onSelect</span><span style="color:#E1E4E8">({ newSelectedIds });</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    [setSelectedItems, onSelect]</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Transparently renders the VirtualList, apart from:</span></span>
<span class="line"><span style="color:#6A737D">  // - storing the selection</span></span>
<span class="line"><span style="color:#6A737D">  // - passing the new selection back to the test</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      selectedItemIds</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{selectedItems}</span></span>
<span class="line"><span style="color:#B392F0">      onSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{handleSelect}</span></span>
<span class="line"><span style="color:#6A737D">      // VirtualList props passed from the test</span></span>
<span class="line"><span style="color:#E1E4E8">      {</span><span style="color:#F97583">...</span><span style="color:#E1E4E8">virtualListProps}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When two items are clicked pressing the meta button, then they are both selected&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">    // Arrange</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // creating the data</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 90</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">      { id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">      { id: </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">      { id: </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // mounting the component</span></span>
<span class="line"><span style="color:#B392F0">    mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      &lt;</span><span style="color:#79B8FF">SelectableList</span></span>
<span class="line"><span style="color:#6A737D">        // test-specific props</span></span>
<span class="line"><span style="color:#B392F0">        onSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{cy.</span><span style="color:#B392F0">spy</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">as</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;onSelect&#39;</span><span style="color:#E1E4E8">)}</span></span>
<span class="line"><span style="color:#6A737D">        // VirtualList props</span></span>
<span class="line"><span style="color:#B392F0">        items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">        getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">        RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#B392F0">        listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#E1E4E8">      /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  /* ... rest of the test ... */</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<p>背景干扰仍然很高，但在阅读测试时你不会遇到它。然后，你是否注意到包装器的调用消耗从</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">mount</span><span style="color:#E1E4E8">(&lt;</span><span style="color:#79B8FF">WithSelectionManagement</span><span style="color:#B392F0"> testHandleSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{cy.</span><span style="color:#B392F0">stub</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">as</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;handleSelect&#39;</span><span style="color:#E1E4E8">)} /&gt;)</span></span></code></pre>
<p>到</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">  &lt;</span><span style="color:#79B8FF">SelectableList</span></span>
<span class="line"><span style="color:#6A737D">    // test-specific props</span></span>
<span class="line"><span style="color:#B392F0">    onSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{cy.</span><span style="color:#B392F0">spy</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">as</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;onSelect&#39;</span><span style="color:#E1E4E8">)}</span></span>
<span class="line"><span style="color:#6A737D">    // VirtualList props</span></span>
<span class="line"><span style="color:#B392F0">    items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">    getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">    RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#B392F0">    listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#E1E4E8">  /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span></code></pre>
<p>？目的是尽可能使代码与之前的更简单的测试相似。<code>SelectableList</code> 现在更透明，因为它只做了一件事情：存储先前的选择。</p>
<h5 id="拆解长的测试">拆解长的测试</h5>
<p>系好安全带：除了包装器，旧测试如下：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When the items are clicked, then they are selected&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  /* ... the code of the wrapper ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=&gt;</span><span style="color:#B392F0"> expect</span><span style="color:#E1E4E8">(testItems).to.have.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">greaterThan</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">))</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">wrap</span><span style="color:#E1E4E8">(testItems).</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(testItems[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">])).</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@handleSelect&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stub</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(stub).to.have.been.calledOnce</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">([testItems[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">].id])</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(testItems[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">])).</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">window</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@handleSelect&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stub</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(stub).to.have.been.calledTwice</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">([testItems[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">].id])</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{meta}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(testItems[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">]))</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@handleSelect&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stub</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(stub).to.have.been.calledThrice</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">([testItems[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">].id, testItems[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">].id])</span></span>
<span class="line"><span style="color:#E1E4E8">      })</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{meta}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{shift}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(testItems[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]))</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@handleSelect&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stub</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">callCount</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">([testItems[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">].id, testItems[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">].id, testItems[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">].id])</span></span>
<span class="line"><span style="color:#E1E4E8">      })</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{shift}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{alt}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(testItems[</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">]))</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@handleSelect&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stub</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">callCount</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">([testItems[</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">].id, testItems[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">].id])</span></span>
<span class="line"><span style="color:#E1E4E8">      })</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{alt}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    fastScrollVirtualList</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">then</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> firstRenderedItemIndex</span><span style="color:#F97583"> =</span><span style="color:#B392F0"> getFirstRenderedItemIndex</span><span style="color:#E1E4E8">(testItems, getItemText)</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> firstRenderedItem</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> testItems[firstRenderedItemIndex]</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> expectedSelectedItemIds</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> testItems</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, firstRenderedItemIndex </span><span style="color:#F97583">+</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">item</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> item.id)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">      cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{shift}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#B392F0">getItemText</span><span style="color:#E1E4E8">(firstRenderedItem))</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@handleSelect&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stub</span><span style="color:#F97583"> =&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">          expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">callCount</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#B392F0">          expect</span><span style="color:#E1E4E8">(stub).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">(expectedSelectedItemIds)</span></span>
<span class="line"><span style="color:#E1E4E8">        })</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{shift}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"><span style="color:#E1E4E8">    })</span></span>
<span class="line"><span style="color:#E1E4E8">  })</span></span>
<span class="line"><span style="color:#E1E4E8">})</span></span></code></pre>
<p>现在看来，看起来有点奇怪的地方：</p>
<ul>
<li><code>cy.then(() =&gt; expect(testItems).to.have.length.greaterThan(0))</code>，因为项目是动态生成的，我在外部函数出现问题时中止了测试。</li>
<li><code>cy.findByText(getItemText(testItems[0])).click()</code> 太过动态，<code>testItems[0]</code> 包含什么？</li>
<li><code>fastScrollVirtualList().then(() =&gt; { /* ... */ }</code> 的内容 😩</li>
<li>测试本身的长度。</li>
<li>不清楚测试一种选择类型在哪里结束，下一个选择类型在哪里开始。</li>
</ul>
<p>让我们首先通过将一个包含四种选择的测试拆分为四个测试来消除对这样一个长测试的需求。</p>
<h6 id="单选">单选</h6>
<p>猜猜看？测试简单的选择根本不需要包装器 😊</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When an item is clicked, then it is selected&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Arrange</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // creating the spy</span></span>
<span class="line"><span style="color:#6A737D">  // a spy is needed to intercept the call the VirtualList does</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> onSelectSpy</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> cy.</span><span style="color:#B392F0">spy</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">as</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;onSelect&#39;</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // creating the data</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // mounting the component</span></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">VirtualList</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#79B8FF">90</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#B392F0">      onSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{onSelectSpy}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Act</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Assert</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@onSelect&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">spy</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(spy).to.have.been.calledOnce;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Sinon matchers allow to assert about partials of the params</span></span>
<span class="line"><span style="color:#6A737D">    // see</span></span>
<span class="line"><span style="color:#6A737D">    // https://sinonjs.org/releases/latest/assertions/</span></span>
<span class="line"><span style="color:#6A737D">    // https://sinonjs.org/releases/latest/matchers/</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(spy).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      Cypress.sinon.</span><span style="color:#B392F0">match</span><span style="color:#E1E4E8">({ newSelectedIds: [</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] })</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(spy).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      Cypress.sinon.</span><span style="color:#B392F0">match</span><span style="color:#E1E4E8">({ item: { id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8"> } })</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>与旧测试的第一部分相比，最显著的变化：</p>
<ul>
<li>不再需要包装器。</li>
<li>不再有动态值。</li>
<li>更有表现力的断言。</li>
<li>这是一个单一目的的测试。</li>
</ul>
<h6 id="累加和减去选择">累加和减去选择</h6>
<p>在这里，我们需要利用包装器。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When two items are clicked pressing the meta button, then they are both selected&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">    // Arrange</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // creating the data</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 90</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">      { id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">      { id: </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">      { id: </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // mounting the component</span></span>
<span class="line"><span style="color:#B392F0">    mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#6A737D">      // mount `SelectableList`instead of `VirtualList`</span></span>
<span class="line"><span style="color:#E1E4E8">      &lt;</span><span style="color:#79B8FF">SelectableList</span></span>
<span class="line"><span style="color:#6A737D">        // test-specific props</span></span>
<span class="line"><span style="color:#B392F0">        onSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{cy.</span><span style="color:#B392F0">spy</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">as</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;onSelect&#39;</span><span style="color:#E1E4E8">)}</span></span>
<span class="line"><span style="color:#6A737D">        // VirtualList props</span></span>
<span class="line"><span style="color:#B392F0">        items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">        getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">        RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#B392F0">        listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#E1E4E8">      /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">    // click on the first item</span></span>
<span class="line"><span style="color:#6A737D">    // Act</span></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">      // Assert</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@onSelect&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">spy</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(spy).to.have.been.calledOnce;</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(spy).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">({ newSelectedIds: [</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">] });</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">    // click on the second item</span></span>
<span class="line"><span style="color:#6A737D">    // Act</span></span>
<span class="line"><span style="color:#6A737D">    // keep the meta button  pressed</span></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{meta}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">      // Assert</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@onSelect&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">spy</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(spy).to.have.been.calledTwice;</span></span>
<span class="line"><span style="color:#B392F0">        expect</span><span style="color:#E1E4E8">(spy).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">({ newSelectedIds: [</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">] });</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span></code></pre>
<p>这里的巨大差异在于避免滚动，因为它不影响累加选择。再次出现显式值，清晰度和简洁性允许进行更直观和更有表现力的测试。</p>
<p>测试减去选择遵循相同的模式。我在这里不报告它。</p>
<h6 id="范围选择">范围选择</h6>
<p>与之前的选择相比，我认为范围选择 <strong>可能会</strong> 受到滚动列表的影响，因为一些将被选择的项目不再呈现。如何使本质上是动态的东西——滚动列表——更加静态？通过手动测试和一些注释。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#B392F0">it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;When the list is scrolled amd some items are clicked pressing the shift button, then the range selection works&#39;</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">  // ------------------------------------------</span></span>
<span class="line"><span style="color:#6A737D">  // Arrange</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // creating the data</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> items</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 2&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 3&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 4&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 5&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 6&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 7&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">8</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 8&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">9</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 9&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 10&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">11</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 11&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">12</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 12&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">13</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 13&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">14</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 14&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">15</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 15&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 16&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">17</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 17&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">18</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 18&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">19</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 19&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { id: </span><span style="color:#79B8FF">20</span><span style="color:#E1E4E8">, name: </span><span style="color:#9ECBFF">&#39;Item 20&#39;</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"><span style="color:#6A737D">  // only 3 items are visible</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> itemHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> listHeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 90</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // mounting the component</span></span>
<span class="line"><span style="color:#B392F0">  mount</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">    &lt;</span><span style="color:#79B8FF">SelectableList</span></span>
<span class="line"><span style="color:#6A737D">      // test-specific props</span></span>
<span class="line"><span style="color:#B392F0">      onSelect</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{cy.</span><span style="color:#B392F0">spy</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">as</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;onSelect&#39;</span><span style="color:#E1E4E8">)}</span></span>
<span class="line"><span style="color:#6A737D">      // VirtualList props</span></span>
<span class="line"><span style="color:#B392F0">      items</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{items}</span></span>
<span class="line"><span style="color:#B392F0">      getItemHeights</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{() </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> itemHeight}</span></span>
<span class="line"><span style="color:#B392F0">      RenderItem</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{RenderItem}</span></span>
<span class="line"><span style="color:#B392F0">      listHeight</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{listHeight}</span></span>
<span class="line"><span style="color:#E1E4E8">    /&gt;</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Act</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // click on the first item</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 1&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // scroll the list</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findAllByTestId</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;VirtualList&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">first</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">trigger</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;wheel&#39;</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    deltaX: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    deltaY: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;body&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">type</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;{shift}&#39;</span><span style="color:#E1E4E8">, { release: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Item 7, 8, 9, and 10 are going to be visible after the scroll</span></span>
<span class="line"><span style="color:#6A737D">  // click on the 10th item. It&#39;s going to be clicked as soon as it&#39;s in the DOM and clickable</span></span>
<span class="line"><span style="color:#E1E4E8">  cy.</span><span style="color:#B392F0">findByText</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;Item 10&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#6A737D">    // Assert</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;@onSelect&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    .</span><span style="color:#B392F0">should</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">spy</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=&gt;</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(spy).to.have.been.calledTwice;</span></span>
<span class="line"><span style="color:#B392F0">      expect</span><span style="color:#E1E4E8">(spy).to.have.been.</span><span style="color:#B392F0">calledWith</span><span style="color:#E1E4E8">({ newSelectedIds: [</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">4</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">6</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">7</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">8</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">9</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">] });</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>这里可能发生的最糟糕的事情是，在触发 <code>wheel</code> 事件时，VirtualList 的滚动逻辑滚动得更少或更多。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto" tabindex="0" data-language="tsx"><code><span class="line"><span style="color:#E1E4E8">cy.</span><span style="color:#B392F0">findAllByTestId</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;VirtualList&#39;</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">first</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">trigger</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">&#39;wheel&#39;</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">  deltaX: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">  deltaY: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span></code></pre>
<p>但如果发生了，由于有注释，读者会清楚地知道出了什么问题 😊</p>
<h3 id="相关的文章">相关的文章</h3>
<ul>
<li>🔗 <a href="https://github.com/NoriSte/ui-testing-best-practices/blob/master/sections/generic-best-practices/test-code-with-debugging-in-mind.zh.md">保持低抽象度以便于调试测试</a></li>
</ul>
<p><em>由<a href="https://github.com/NoriSte">NoriSte</a>在<a href="https://dev.to/noriste/from-unreadable-react-component-tests-to-simple-stupid-ones-3ge6">dev.to</a>进行联合发表。</em></p>
<h3 id="参考资料">参考资料</h3>
<ul>
<li>UI 测试最佳实践项目:<a href="https://github.com/NoriSte/ui-testing-best-practices">https://github.com/NoriSte/ui-testing-best-practices</a></li>
<li>UI 测试最佳实践项目中文翻译:<a href="https://github.com/naodeng/ui-testing-best-practices">https://github.com/naodeng/ui-testing-best-practices</a></li>
</ul>
<hr/>
<p>欢迎关注软件测试同学的公众号“<strong>软件测试同学</strong>”，原创 QA 技术文章第一时间推送。</p>


<div style="text-align: center"><img src="https://cdn.jsdelivr.net/gh/naodeng/blogimg@master/uPic/2023112015'QR Code for 公众号.jpg" style="width: 100px;"/></div>

  </article>  </main> <footer class="l-footer l-content" data-astro-cid-sz7xmlte> <a href="https://github.com/naodeng/naodeng.com.cn" target="_blank" class="github" data-astro-cid-sz7xmlte>
GitHub
<span class="material-icons-sharp dir" data-astro-cid-sz7xmlte>open_in_new</span> </a> <ul data-astro-cid-sz7xmlte> <li><a href="/en/" onclick="localStorage.selectedLang = &#34;en&#34;" lang="en">English</a></li><li><a href="/zh-cn/" onclick="localStorage.selectedLang = &#34;zh-cn&#34;" lang="zh-cn">简体中文</a></li> </ul> <a class="copy" href="https://naodeng.com.cn/" target="_blank" dir="ltr" data-astro-cid-sz7xmlte>
© Nao Deng 2026 </a> </footer>   </body> </html>  